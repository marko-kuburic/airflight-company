# Air Company - Docker Setup

This document provides instructions for running the Air Company Spring Boot application using Docker Compose.

## Prerequisites

- Docker (version 20.10+)
- Docker Compose (version 2.0+)
- At least 4GB of available RAM
- Ports 8080, 3306, 6379 available (or configure different ports)

## Quick Start

### 1. Clone and Navigate
```bash
cd /home/marko/Documents/air-company
```

### 2. Build and Run (Basic Setup)
```bash
# Build and start the application with MySQL
docker-compose up --build

# Or run in detached mode
docker-compose up --build -d
```

### 3. Access the Application
- **API**: http://localhost:8080/api
- **Health Check**: http://localhost:8080/api/actuator/health
- **MySQL**: localhost:3306 (user: aircompany, password: aircompany123)

## Advanced Setup Options

### Option 1: MySQL + Admin Tools
```bash
# Start with phpMyAdmin for database management
docker-compose --profile admin up --build -d

# Access phpMyAdmin at: http://localhost:8081
```


### Option 2: Full Stack with Nginx
```bash
# Start with Nginx reverse proxy and load balancer
docker-compose --profile nginx up --build -d

# Access through Nginx at: http://localhost:80
```

### Option 3: Complete Setup (All Services)
```bash
# Start all services including admin tools and nginx
docker-compose --profile admin --profile nginx up --build -d
```

## Service Configuration

### Default Services
- **app**: Spring Boot application (port 8080)
- **mysql**: MySQL 8.0 database (port 3306)
- **redis**: Redis cache (port 6379)

### Optional Services (use profiles)
- **nginx**: Reverse proxy (port 80) - `--profile nginx`
- **phpmyadmin**: MySQL admin interface (port 8081) - `--profile admin`

## Environment Variables

Copy `docker.env` to `.env` and modify as needed:

```bash
cp docker.env .env
```

Key variables:
- `MYSQL_PASSWORD`: MySQL password
- `SPRING_DATASOURCE_PASSWORD`: Application database password
- `JWT_SECRET`: JWT signing secret
- `APP_PORT`: Application port (default: 8080)

## Database Access

### MySQL
The database schema is automatically created by Spring Boot JPA from the entity definitions.

```bash
# Connect to MySQL container
docker exec -it air-company-mysql mysql -u aircompany -p air_company

# Or use phpMyAdmin (if admin profile is active)
# Visit: http://localhost:8081
```

**Note**: The database schema is automatically generated by Spring Boot JPA based on your entity classes. No manual DDL scripts are needed.


## Monitoring and Logs

### View Logs
```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f app
docker-compose logs -f mysql
```

### Health Checks
```bash
# Check service status
docker-compose ps

# Check application health
curl http://localhost:8080/api/actuator/health
```

### Resource Usage
```bash
# View resource usage
docker stats
```

## Development Workflow

### Rebuild Application
```bash
# Rebuild only the app service
docker-compose build app

# Rebuild and restart
docker-compose up --build app
```

### Database Reset
```bash
# Stop services and remove volumes
docker-compose down -v

# Restart with fresh databases
docker-compose up --build
```

### Hot Reload (Development)
For development with hot reload, you can mount the source code:

```bash
# Add volume mount to app service in docker-compose.yml
volumes:
  - ./src:/app/src
  - ./target:/app/target
```

## Troubleshooting

### Common Issues

1. **Port Already in Use**
   ```bash
   # Check what's using the port
   lsof -i :8080
   
   # Change port in docker.env
   APP_PORT=8081
   ```

2. **Database Connection Issues**
   ```bash
   # Check database logs
   docker-compose logs mysql
   
   # Verify database is ready
   docker-compose exec mysql mysqladmin ping -h localhost
   ```

3. **Application Won't Start**
   ```bash
   # Check application logs
   docker-compose logs app
   
   # Verify database connectivity from app container
   docker-compose exec app curl http://mysql:3306
   ```

4. **Memory Issues**
   ```bash
   # Increase Docker memory limit
   # Docker Desktop: Settings > Resources > Memory
   ```

### Clean Up
```bash
# Stop and remove containers
docker-compose down

# Remove containers, networks, and volumes
docker-compose down -v

# Remove everything including images
docker-compose down -v --rmi all
```

## Production Considerations

1. **Security**: Change default passwords in `.env`
2. **SSL**: Configure SSL certificates for Nginx
3. **Backup**: Set up database backups
4. **Monitoring**: Add monitoring and logging solutions
5. **Scaling**: Configure multiple app instances behind load balancer

## API Endpoints

Once running, the application provides these main endpoints:

- `GET /api/actuator/health` - Health check
- `GET /api/actuator/info` - Application info
- `POST /api/auth/login` - User authentication
- `GET /api/users` - User management
- `GET /api/flights` - Flight information
- `GET /api/reservations` - Reservation management

## Support

For issues or questions:
1. Check the logs: `docker-compose logs`
2. Verify environment variables in `.env`
3. Ensure all required ports are available
4. Check Docker and Docker Compose versions
